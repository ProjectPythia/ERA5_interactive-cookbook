{"version":2,"kind":"Notebook","sha256":"8034f773b8aff0397492fa9bac6425bca574ddce193a710f1d892108be92961b","slug":"notebooks.data-preprocessing","location":"/notebooks/05_data_preprocessing.ipynb","dependencies":[],"frontmatter":{"title":"Generate annual/yearly zarr stores from hourly ERA5 NetCDF files on NCAR’s Research Data Archive","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"open_access":true,"license":{"content":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true},"code":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true}},"github":"https://github.com/projectpythia/ERA5_interactive-cookbook","affiliations":[{"id":"University at Albany (State University of New York)","name":"University at Albany (State University of New York)"},{"id":"UCAR/NCAR","name":"UCAR/NCAR"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/ERA5_interactive-cookbook/blob/main/notebooks/05_data_preprocessing.ipynb","exports":[{"format":"ipynb","filename":"05_data_preprocessing.ipynb","url":"/ERA5_interactive-cookbook/build/05_data_preprocessin-ee9773cd6bf24fe12676f5aa77adee5a.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview and Warning: Please Read","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X132OMwk51"}],"identifier":"overview-and-warning-please-read","label":"Overview and Warning: Please Read","html_id":"overview-and-warning-please-read","implicit":true,"key":"VoQQIFWVYA"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":2,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"ERA5 data on NCAR is stored in hourly NetCDF files. Therefore, it is necessary to create intermediate ARCO datasets for fast processing.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ONqPwxVmuJ"}],"key":"dOewHEvKHH"}],"key":"mQy9GMSIoH"},{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this notebook, we read hourly data from NCAR’s publicly accessible ERA5 collection using an intake catalog, compute the annual means and store the result using zarr stores.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XYy8T15upB"}],"key":"UKhVYbbCk4"}],"key":"kQQ24K5YUE"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"If you don’t have write permision to save to the Research Data Archive (RDA), please save the result to your local folder.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"AFig5ehwJu"}],"key":"MTpp3Tx2J4"}],"key":"SEt93ryMYS"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"If you need annual means for the following variables, please don’t run this notebook. The data has already been calculated and can be accessed via https from ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"oY4NH6hxWl"},{"type":"link","url":"https://data.rda.ucar.edu/pythia_era5_24/annual_means/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"https://​data​.rda​.ucar​.edu​/pythia​_era5​_24​/annual​_means/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"XG4Q9KqStx"}],"urlSource":"https://data.rda.ucar.edu/pythia_era5_24/annual_means/","key":"ClhbW9TfdM"}],"key":"btU5jHVXAR"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Air temperature at 2 m/ VAR_2T (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"J5ni85cypH"},{"type":"link","url":"https://data.rda.ucar.edu/pythia_era5_24/annual_means/temp_2m_annual_1940_2023.zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"https://​data​.rda​.ucar​.edu​/pythia​_era5​_24​/annual​_means​/temp​_2m​_annual​_1940​_2023​.zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"hyNkfHvIfJ"}],"urlSource":"https://data.rda.ucar.edu/pythia_era5_24/annual_means/temp_2m_annual_1940_2023.zarr","key":"qKCss2sxQ5"},{"type":"text","value":")","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"PzcIQyImjG"}],"key":"x6eOTuOOio"}],"key":"khlu1x85E1"}],"key":"NKDg3yw1dY"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Otherwise, please run this script once to generate the annual means.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"qIdKdEg29W"}],"key":"y55gaP2rbK"}],"key":"CR6qV63qeR"}],"key":"DngR3lOy0A"}],"key":"vdSYH5c7zG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Rcdb1DEyzS"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"nvosOxT7Kv"},{"type":"table","position":{"start":{"line":3,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tlhpN0fvDs"}],"key":"l4s42pfwnj"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"alZ7QIu9rD"}],"key":"aF66C9UWc9"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"spS3RnCjHk"}],"key":"r1Hp8gN6Ps"}],"key":"oQiDQP8DaW"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray.html","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Intro to Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Bd9bJDTNwM"}],"urlSource":"https://foundations.projectpythia.org/core/xarray.html","key":"OM8OkVmolC"}],"key":"Rc26vSoa8E"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yK8mmcafbE"}],"key":"RaytomtEHi"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[],"key":"arnHtk1gy4"}],"key":"ozu68FXw7e"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"link","url":"https://projectpythia.org/intake-cookbook/notebooks/intake_introduction.html","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Intro to Intake","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"iE9bue0Rrw"}],"urlSource":"https://projectpythia.org/intake-cookbook/notebooks/intake_introduction.html","key":"CmO0agd221"}],"key":"iHOAi7K94Z"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"rgIxcCYZRg"}],"key":"ywSbnXmCYO"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[],"key":"RLWY6EXB5Y"}],"key":"BbtybGUNxT"},{"type":"tableRow","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"link","url":"https://zarr.readthedocs.io/en/stable/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Understanding of Zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"PkthB8yj3d"}],"urlSource":"https://zarr.readthedocs.io/en/stable/","key":"h6l6uYpCPG"}],"key":"igeTyOkVZn"},{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Helpful","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ALfscrpB8I"}],"key":"twOCkcfWqe"},{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[],"key":"oZBaGOxfvu"}],"key":"j5ps0BaPGZ"}],"key":"C1AXk2u7C0"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"aYHWma6ZVN"}],"key":"JW8LFKwOAC"},{"type":"text","value":": 30 minutes","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"zh1zYlVolD"}],"key":"IAtpqfv66U"}],"key":"rNPVIscYxQ"}],"key":"whJvsoRY3r"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kiqF3X2R5h"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"GtH0GvmFTW"}],"key":"z1NN5bxKZo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import glob\nimport re\nimport matplotlib as plt\nimport numpy as np\nimport scipy as sp\nimport xarray as xr\nimport intake\nimport intake_esm\nimport pandas as pd","key":"tkVV8YMWsM"},{"type":"output","id":"PlNXfsfnO2FFmqKUqRDnp","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mModuleNotFoundError\u001b[39m                       Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 7\u001b[39m\n\u001b[32m      5\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mscipy\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01msp\u001b[39;00m\n\u001b[32m      6\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mxarray\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mxr\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m7\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mintake\u001b[39;00m\n\u001b[32m      8\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mintake_esm\u001b[39;00m\n\u001b[32m      9\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mpandas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mpd\u001b[39;00m\n\n\u001b[31mModuleNotFoundError\u001b[39m: No module named 'intake'","ename":"ModuleNotFoundError","evalue":"No module named 'intake'"}],"key":"qBfB2DPK18"}],"key":"butafPUjmc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import dask\nfrom dask.distributed import Client, performance_report\nfrom dask_jobqueue import PBSCluster","key":"NYQ0CaQLXJ"},{"type":"output","id":"XbmyOAggqj8PECDwNLQwt","data":[],"key":"AwSmU8qdax"}],"key":"fo8nfzmq6i"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"######## File paths ################\nrda_scratch       = \"/gpfs/csfs1/collections/rda/scratch/harshah\"\nrda_data          = \"/gpfs/csfs1/collections/rda/data/\"\n#########\nrda_url           = 'https://data.rda.ucar.edu/'\nera5_catalog      = rda_url + 'pythia_era5_24/pythia_intake_catalogs/era5_catalog.json'\n#alternate_catalog = rda_data + 'pythia_era5_24/pythia_intake_catalogs/era5_catalog_opendap.json'\nannual_means      =  rda_data + 'pythia_era5_24/annual_means/'\n######## \nzarr_path         = rda_scratch + \"/tas_zarr/\"\n##########\nprint(annual_means)","key":"GcJ2EvA5eO"},{"type":"output","id":"8-6IRFy8F9YjHz-WEnUEe","data":[],"key":"xyonc4ZN03"}],"key":"YJo3siA3l0"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a Dask cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RgUw6sGJkY"}],"identifier":"create-a-dask-cluster","label":"Create a Dask cluster","html_id":"create-a-dask-cluster","implicit":true,"key":"Dv1JakWGW9"}],"key":"XQKcVAm3uV"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dask Introduction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fKlj5VESLg"}],"identifier":"dask-introduction","label":"Dask Introduction","html_id":"dask-introduction","implicit":true,"key":"IHXWZwG1lw"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://www.dask.org/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JGKCUuWuMc"}],"urlSource":"https://www.dask.org/","key":"o1l1XyhgGv"},{"type":"text","value":" is a solution that enables the scaling of Python libraries. It mimics popular scientific libraries such as numpy, pandas, and xarray that enables an easier path to parallel processing without having to refactor code.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DcY6UwYCZL"}],"key":"TRrvV17GJL"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"There are 3 components to parallel processing with Dask: the client, the scheduler, and the workers.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CykqKVtQBj"}],"key":"XOZjqp6Far"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The Client is best envisioned as the application that sends information to the Dask cluster. In Python applications this is handled when the client is defined with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"oRi54dK8ia"},{"type":"inlineCode","value":"client = Client(CLUSTER_TYPE)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jibtDLUZti"},{"type":"text","value":". A Dask cluster comprises of a single scheduler that manages the execution of tasks on workers. The ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Zo73oFc9Vn"},{"type":"inlineCode","value":"CLUSTER_TYPE","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"kVZk0Slvn1"},{"type":"text","value":" can be defined in a number of different ways.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"p0FSF3qbNK"}],"key":"wK5pyGthIh"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"There is LocalCluster, a cluster running on the same hardware as the application and sharing the available resources, directly in Python with ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"AxDJqO9QsZ"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"wbPZFMiGab"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"gVYIDNpdDC"}],"key":"NyU3qJjBh0"}],"key":"QYFkLzaTbA"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"In certain JupyterHubs Dask Gateway may be available and a dedicated dask cluster with its own resources can be created dynamically with ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"aeFKr8p0UC"},{"type":"inlineCode","value":"dask.gateway","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"mfPM3rhaQV"},{"type":"text","value":".","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"NC0qn1qDf9"}],"key":"AAwuTDiCTK"}],"key":"TESa1YyFSG"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"On HPC systems ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"Qd5evXAPCL"},{"type":"inlineCode","value":"dask_jobqueue","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"VQCTJ6W6Ii"},{"type":"text","value":" is used to connect to the HPC Slurm and PBS job schedulers to provision resources.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"l2UqP6kjck"}],"key":"L2OdJI6EOy"}],"key":"PY4CzOPgAR"}],"key":"DOAL3g3lxZ"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"hEVQGJwIv8"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"jI3D2ZVNxx"},{"type":"text","value":" client python module can also be used to connect to existing clusters. A Dask Scheduler and Workers can be deployed in containers, or on Kubernetes, without using a Python function to create a dask cluster. The ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"eTq22HCJsX"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Rtvl4uYOir"},{"type":"text","value":" Client is configured to connect to the scheduler either by container name, or by the Kubernetes service name.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"rFiOo8acao"}],"key":"ejAYCRDtQY"}],"key":"INe3KaCdZe"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Select the Dask cluster type","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PTjZ1cKcYw"}],"identifier":"select-the-dask-cluster-type","label":"Select the Dask cluster type","html_id":"select-the-dask-cluster-type","implicit":true,"key":"j2r0cCFYoO"}],"key":"sscTdkMi2M"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The default will be ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LmzpdcxH2K"},{"type":"inlineCode","value":"LocalCluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EpzhXy3qYe"},{"type":"text","value":" as that can run on any system.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iRUx8QNxOV"}],"key":"ySQe7v7T76"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"If running on a HPC computer with a PBS Scheduler, set to True. Otherwise, set to False.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MYy0LRXYfY"}],"key":"YfaJNIsftZ"}],"key":"Oh8mkr7inx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"USE_PBS_SCHEDULER = True","key":"saYtJkuBcy"},{"type":"output","id":"VLmF1LvBxHuuNKlpf71Ns","data":[],"key":"rGnwLbgTCs"}],"key":"V3vE05pSrI"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If running on Jupyter server with Dask Gateway configured, set to True. Otherwise, set to False.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XIE50pLPE6"}],"key":"wHD2XWNRli"}],"key":"TLGedpIBUm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"USE_DASK_GATEWAY = False","key":"ZJVMsfhoES"},{"type":"output","id":"tap1-FcwhI6i-H_TZIWIP","data":[],"key":"Ax1U8T0UoS"}],"key":"aMATTelXt7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python function for a PBS cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nel9v39F0Y"}],"key":"VImCFiwk5J"}],"key":"sOz5g2zrFG"}],"key":"JfOWrlZHuy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create a PBS cluster object\ndef get_pbs_cluster():\n    \"\"\" Create cluster through dask_jobqueue.   \n    \"\"\"\n    from dask_jobqueue import PBSCluster\n    cluster = PBSCluster(\n        job_name = 'dask-pythia-24',\n        cores = 1,\n        memory = '4GiB',\n        processes = 1,\n        local_directory = rda_scratch + '/dask/spill',\n        resource_spec = 'select=1:ncpus=1:mem=8GB',\n        queue = 'casper',\n        walltime = '1:00:00',\n        #interface = 'ib0'\n        interface = 'ext'\n    )\n    return cluster","key":"a0wtKSXss1"},{"type":"output","id":"UUQy9pz3YzQ6NMTZpNR2F","data":[],"key":"bsN3jlHbAK"}],"key":"A6OeND1dtu"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python function for a Gateway Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vaIjokJbID"}],"key":"ygSowheCO8"}],"key":"vPdgZhfJX7"}],"key":"MQfDep65xE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_gateway_cluster():\n    \"\"\" Create cluster through dask_gateway\n    \"\"\"\n    from dask_gateway import Gateway\n\n    gateway = Gateway()\n    cluster = gateway.new_cluster()\n    cluster.adapt(minimum=2, maximum=4)\n    return cluster","key":"ZOty8DkpK1"},{"type":"output","id":"0-U82ocZ2-Jdfah8zjwZl","data":[],"key":"GemfbqDLfa"}],"key":"OR0KoeWNbZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python function for a Local Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A3ePb9rWvY"}],"key":"EbF2aepCab"}],"key":"b136TGRBu0"}],"key":"iPacL8gaY9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_local_cluster():\n    \"\"\" Create cluster using the Jupyter server's resources\n    \"\"\"\n    from distributed import LocalCluster, performance_report\n    cluster = LocalCluster()    \n\n    cluster.scale(4)\n    return cluster","key":"Sh1iuXf8cx"},{"type":"output","id":"bOkkb0G_cmzcjcBBpd8qc","data":[],"key":"VXqtbL2mrZ"}],"key":"tmkG0gERpi"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python logic to select the Dask Cluster type","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pMFqweT67N"}],"key":"FOY4qV2Ctc"}],"key":"p9B6KGxPvP"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This uses True/False boolean logic based on the variables set in the previous cells","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kb5H0Xditd"}],"key":"lulfL7gwsT"}],"key":"h4SoTuUPYI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Obtain dask cluster in one of three ways\n\nif USE_PBS_SCHEDULER:\n    cluster = get_pbs_cluster()\nelif USE_DASK_GATEWAY:\n    cluster = get_gateway_cluster()\nelse:\n    cluster = get_local_cluster()\n\n# Connect to cluster\nfrom distributed import Client\nclient = Client(cluster)\n\n# Display cluster dashboard URL\ncluster","key":"i2E6R1ITS4"},{"type":"output","id":"0yMc4sPokvqnwn1eAzxJp","data":[],"key":"ujjJJVbRdP"}],"key":"pXCwBCrT69"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Find data using intake catalog","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"grvKmeEQ8n"}],"identifier":"find-data-using-intake-catalog","label":"Find data using intake catalog","html_id":"find-data-using-intake-catalog","implicit":true,"key":"ZjaGweJARk"}],"key":"Tb05jfqfru"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"era5_cat = intake.open_esm_datastore(era5_catalog)\nera5_cat","key":"lpQvtI57IK"},{"type":"output","id":"bygCs4KqD8vEhrIky72wo","data":[],"key":"NbRY2mSM3a"}],"key":"R9pVelksjr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"era5_cat.df[['long_name','variable']].drop_duplicates().head()","key":"u4VQoODFvJ"},{"type":"output","id":"QGWw-3ikiql_3VMQkZ9cK","data":[],"key":"JwLDyBNe4M"}],"key":"J7OE7s2nzx"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Select variable of interest","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UWVlyVp7pC"}],"identifier":"select-variable-of-interest","label":"Select variable of interest","html_id":"select-variable-of-interest","implicit":true,"key":"CWRQJIgWX6"}],"key":"r7Fkepo1NH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"######## Examples of other Variables ##############\n# MTNLWRF = Outgoing Long Wave Radiation (upto a sign), Mean Top Net Long Wave Radiative Flux\n# rh_cat = era5_cat.search(variable= 'R') # R =  Relative Humidity\n# olr_cat = era5_cat.search(variable ='MTNLWRF')\n# olr_cat\n############ Access temperature data ###########\ntemp_cat = era5_cat.search(variable='VAR_2T',frequency = 'hourly')\ntemp_cat","key":"Ho5mChKrSN"},{"type":"output","id":"oR1_zyI2kM_ku_4l2OKKx","data":[],"key":"qERkj3uz9O"}],"key":"Bs3K5Rz3nD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Define the xarray_open_kwargs with a compatible engine, for example, 'scipy'\nxarray_open_kwargs = {\n    'engine': 'h5netcdf',\n    'chunks': {},  # Specify any chunking if needed\n    'backend_kwargs': {}  # Any additional backend arguments if required\n}","key":"MqtB3AxJWG"},{"type":"output","id":"fVUQtS5NeSf6ySTgQlimw","data":[],"key":"gVrmlnSju7"}],"key":"WTC8QUBwUh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\ndset_temp = temp_cat.to_dataset_dict(xarray_open_kwargs=xarray_open_kwargs)","key":"tBvS8xiznY"},{"type":"output","id":"b2kkWlv-h5MLNrEuXVdMV","data":[],"key":"kCWk3akesK"}],"key":"y9jwhB6LK8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dset_temp.keys()","key":"SNPYFHeDXf"},{"type":"output","id":"GyNewmgH4n02Lkhwo050b","data":[],"key":"uOZiIBn0HS"}],"key":"FfQRKS4LZr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_2m = dset_temp['an.sfc'].VAR_2T\ntemp_2m","key":"JRAJ0Mmdzn"},{"type":"output","id":"eWTY7dHdY6M2g7UgYH-k_","data":[],"key":"TDW23wxAIv"}],"key":"V1XXom5cZp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_2m_annual = temp_2m.resample(time='1Y').mean()\ntemp_2m_annual","key":"BtSzoeSR7j"},{"type":"output","id":"zvEDBYryx0a3XfdBKGVhM","data":[],"key":"LwgQucsgrL"}],"key":"udcjifqEh9"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Save the notbeook","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W1IxS83f7e"}],"identifier":"save-the-notbeook","label":"Save the notbeook","html_id":"save-the-notbeook","implicit":true,"key":"g8q5Gp8TEi"}],"key":"Us8q4p3EVE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# temp_2m_annual.to_dataset().to_zarr(zarr_path + \"e5_tas2m_monthly_1940_2023.zarr)","key":"LgR7k8G3xj"},{"type":"output","id":"bw_IjrGYpwdS5Am6pnRxm","data":[],"key":"H8Q1ufXHnP"}],"key":"oehMcYb7GO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_2m_monthly = xr.open_zarr(zarr_path + \"e5_tas2m_monthly_1940_2023.zarr\").VAR_2T\ntemp_2m_monthly","key":"UdWdCuF9WA"},{"type":"output","id":"w8vMFeJhYyCAo80w-Wbc6","data":[],"key":"Ev5Q45HFFW"}],"key":"mu5yEKYGYv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_2m_annual = temp_2m_monthly.resample(time='1Y').mean()\ntemp_2m_annual = temp_2m_annual.chunk({'latitude':721,'longitude':1440})\ntemp_2m_annual = temp_2m_annual.drop_isel({'time':-1}) # Drop 2024 data\ntemp_2m_annual","key":"uKwV8ehNif"},{"type":"output","id":"siK2JnP0sTioyKygz_L9i","data":[],"key":"s3PMmLgidu"}],"key":"NLIazXEMjz"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Save annual mean to annual_means folder within rda_data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"skt63N4jyV"}],"identifier":"save-annual-mean-to-annual-means-folder-within-rda-data","label":"Save annual mean to annual_means folder within rda_data","html_id":"save-annual-mean-to-annual-means-folder-within-rda-data","implicit":true,"key":"kws3RmfEQR"}],"key":"WrMOE9PEnu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# %%time\n# temp_2m_annual.to_dataset().to_zarr(annual_means + 'temp_2m_annual_1940_2023.zarr',mode='w')","key":"dGVT4F6tsQ"},{"type":"output","id":"Nx6LsRiUztphoTqvZllqX","data":[],"key":"yZryuH0fcK"}],"key":"SapKa1HuKg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_2m_annual = xr.open_zarr(annual_means + 'temp_2m_annual_1940_2023.zarr').VAR_2T\ntemp_2m_annual ","key":"ISGI8OIfyl"},{"type":"output","id":"1j3r3NCw3KYhwHHKiOw5Y","data":[],"key":"ZcX9X1d91C"}],"key":"mKebqVN1Vw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\ntemp_2m_annual.isel(time=0).plot()","key":"RCPjWW1etV"},{"type":"output","id":"7npvhhWWTxNRVQGiUBzon","data":[],"key":"cmVSUWenwv"}],"key":"BG4Ul9p70l"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Close up the cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H2wEuhSD2L"}],"identifier":"close-up-the-cluster","label":"Close up the cluster","html_id":"close-up-the-cluster","implicit":true,"key":"DXjrpTiH8v"}],"key":"COBCbq9NoU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cluster.close()","key":"Io1CKsugn5"},{"type":"output","id":"yF4lfk_YWQkCpdaDvCqzJ","data":[],"key":"sD0ztazUJU"}],"key":"Sz2Qn7UGqC"}],"key":"fo5aGErb1k"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Creating an Interactive Dashboard using hvPlot and Panel","url":"/notebooks/dashboard","group":"Visualization Notebooks"},"next":{"title":"Access ERA5 data from NCAR’s Research Data Archive and compute anomaly","url":"/notebooks/era5-anomaly","group":"Preprocessing Notebooks for NCAR RDA"}}},"domain":"http://localhost:3000"}