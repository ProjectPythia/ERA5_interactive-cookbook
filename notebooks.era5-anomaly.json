{"version":2,"kind":"Notebook","sha256":"3f11dc9c3d2a95e714a1c3c334749070e80794ad6df176472965012f179f59c6","slug":"notebooks.era5-anomaly","location":"/notebooks/06_era5_anomaly.ipynb","dependencies":[],"frontmatter":{"title":"Access ERA5 data from NCAR’s Research Data Archive and compute anomaly","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/ERA5_interactive-cookbook","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/ERA5_interactive-cookbook/blob/main/notebooks/06_era5_anomaly.ipynb","exports":[{"format":"ipynb","filename":"06_era5_anomaly.ipynb","url":"/ERA5_interactive-cookbook/build/06_era5_anomaly-fc65c2f7a8265e0a93a02e07caa0a635.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dxTci2HVTf"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"cKzXpymiEe"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ERA-5 Dataset is available from NCAR’s RDA in netcdf format as hourly files. A subset of this dataset is processed into Zarr format and available from NCAR RDA endpoints. To learn how you can create Zarr files from NCAR RDA netcdf files, please see ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZGObd3UaVT"},{"type":"link","url":"/notebooks/data-preprocessing","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"this notebook","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"D6BwGRmA9L"}],"urlSource":"./05_data_preprocessing.ipynb","dataUrl":"/notebooks.data-preprocessing.json","internal":true,"protocol":"file","key":"p137KdSgMe"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oqfovg7VGL"}],"key":"n3n9cgHO7D"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"In this notebook,","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"jv9SsNZA6X"}],"key":"bcu4G3RNHQ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We will read data zarr stores from NCAR’s RDA endpoint","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"GBd27k656r"}],"key":"xIv1HzEEwL"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Compute temperature anomaly for the years 1940-2023","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"qYEtD9kHIp"}],"key":"lxvS3zpyhp"}],"key":"CDG6PfOWfK"}],"key":"pKZaDL6VQi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XEQzAQkPyX"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"XtAMwGdl77"},{"type":"table","position":{"start":{"line":3,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MVcXv3Lxhr"}],"key":"BsEscd960D"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dozAxjyeXN"}],"key":"wZ4nvn4W4Y"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"i9jtXTbjtW"}],"key":"PKcfotZ2VU"}],"key":"siOaXTw7pn"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray.html","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Intro to Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"mITUlKKwJE"}],"urlSource":"https://foundations.projectpythia.org/core/xarray.html","key":"fraPIV5Mof"}],"key":"UP9ftKGI8z"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"NDjefvhNc4"}],"key":"PS7Q3hDbUV"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[],"key":"mBLmYXKTOw"}],"key":"OKoMtnBBJv"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"link","url":"https://projectpythia.org/intake-cookbook/notebooks/intake_introduction.html","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Intro to Intake","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"suqOsHVfxP"}],"urlSource":"https://projectpythia.org/intake-cookbook/notebooks/intake_introduction.html","key":"NXjXoLm23h"}],"key":"QxUpBpF0SV"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DTQ7JUz4S6"}],"key":"YeEIBzNghw"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[],"key":"ZFv9zKh6ya"}],"key":"IDhfG2yzDR"},{"type":"tableRow","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"link","url":"https://zarr.readthedocs.io/en/stable/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Understanding of Zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"vBvp1wAMlk"}],"urlSource":"https://zarr.readthedocs.io/en/stable/","key":"CSaitKOX6d"}],"key":"n7V2jGjOCw"},{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Helpful","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"cAPjoGEKRZ"}],"key":"ingPjiOXiy"},{"type":"tableCell","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[],"key":"EVhM1hJV8T"}],"key":"nKb2asxObR"}],"key":"Tqcqr06Ds9"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"rOL91WlHSU"}],"key":"Qk5aQFe7jM"},{"type":"text","value":": 30 minutes","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"MbqLTYiIB3"}],"key":"iiq7xnyJhp"}],"key":"wqwu8VLXum"}],"key":"GyDEGead0y"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WgIUi8L7Jz"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"v4RIXGpIcG"}],"key":"BrFkAkGmuu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\nimport numpy as np\nimport xarray as xr\nimport intake_esm\nimport intake\nimport pandas as pd\nimport cartopy.crs as ccrs  # Correct import for coordinate reference systems\nimport cartopy.feature as cfeature\nfrom holoviews import opts\nimport geoviews as gv\nimport holoviews as hv\nimport aiohttp","key":"SoQzQF7FPn"},{"type":"output","id":"oB_SL7WFUAqAPZNfM7tgc","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mModuleNotFoundError\u001b[39m                       Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 4\u001b[39m\n\u001b[32m      2\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mnumpy\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mnp\u001b[39;00m\n\u001b[32m      3\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mxarray\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mxr\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m4\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mintake_esm\u001b[39;00m\n\u001b[32m      5\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mintake\u001b[39;00m\n\u001b[32m      6\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mpandas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mpd\u001b[39;00m\n\n\u001b[31mModuleNotFoundError\u001b[39m: No module named 'intake_esm'","ename":"ModuleNotFoundError","evalue":"No module named 'intake_esm'"}],"key":"DYOPCkmmUB"}],"key":"fkKibslHd8"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Specify global variables","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZI679qhWWy"}],"identifier":"specify-global-variables","label":"Specify global variables","html_id":"specify-global-variables","implicit":true,"key":"rab023ek7a"}],"key":"tutPAdRjUM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"baseline_year_start = 1940\nbaseline_year_end   = 1949\ncurrent_year  = 2023","key":"WMAmeSfPnU"},{"type":"output","id":"cTXxuPks5Y008SvsORYtF","data":[],"key":"TppWqGiYTO"}],"key":"H5LUKmrdKk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"rda_data          = '/gpfs/csfs1/collections/rda/data/'\nrda_url           = 'https://data.rda.ucar.edu/'\n#era5_catalog      = rda_url + 'pythia_intake_catalogs/era5_catalog.json'\n#\nannual_means      =  rda_url + 'pythia_era5_24/annual_means/'\nannual_means_posix=  rda_data + 'pythia_era5_24/annual_means/'\ntemp_annual_means =  annual_means + ''\n#\nprint(annual_means)","key":"uSEXp6CGQo"},{"type":"output","id":"1xsGct0W8H3waWbsYpz7p","data":[],"key":"px6B24OYMp"}],"key":"zf3JEA6dD1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a Dask cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JT5xqWh7Ok"}],"identifier":"create-a-dask-cluster","label":"Create a Dask cluster","html_id":"create-a-dask-cluster","implicit":true,"key":"ushKjJgBht"}],"key":"Z8RgKF5XaW"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dask Introduction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ntw3Y2wXBY"}],"identifier":"dask-introduction","label":"Dask Introduction","html_id":"dask-introduction","implicit":true,"key":"CfpjwSPSME"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"link","url":"https://www.dask.org/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vVjA1eS0NX"}],"urlSource":"https://www.dask.org/","key":"I5B4um1NIU"},{"type":"text","value":" is a solution that enables the scaling of Python libraries. It mimics popular scientific libraries such as numpy, pandas, and xarray that enables an easier path to parallel processing without having to refactor code.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gk5ampLIpS"}],"key":"ZvYavB62u9"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"There are 3 components to parallel processing with Dask: the client, the scheduler, and the workers.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zHuAnNOGfV"}],"key":"fHIrCjKfzt"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The Client is best envisioned as the application that sends information to the Dask cluster. In Python applications this is handled when the client is defined with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RCHmy98LpE"},{"type":"inlineCode","value":"client = Client(CLUSTER_TYPE)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"zZqihMaRXz"},{"type":"text","value":". A Dask cluster comprises of a single scheduler that manages the execution of tasks on workers. The ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"PTnB9tg0NR"},{"type":"inlineCode","value":"CLUSTER_TYPE","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"QKlqBrEHzp"},{"type":"text","value":" can be defined in a number of different ways.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"upborPndZW"}],"key":"CwDqBhFn4C"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":9,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"There is LocalCluster, a cluster running on the same hardware as the application and sharing the available resources, directly in Python with ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"GYcldB39vw"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"TU9km2fin0"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"FN8LWpCaBN"}],"key":"RG4XeuhEQm"}],"key":"GlAFi9hsbO"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"In certain JupyterHubs Dask Gateway may be available and a dedicated dask cluster with its own resources can be created dynamically with ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"bBEy4rDxhK"},{"type":"inlineCode","value":"dask.gateway","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"bFNMLFRagd"},{"type":"text","value":".","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"FmZHJfVeZg"}],"key":"oURp2SRie2"}],"key":"VFV4PmK4zW"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"On HPC systems ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"hRGVWCd4xC"},{"type":"inlineCode","value":"dask_jobqueue","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"SwQRT7K0BJ"},{"type":"text","value":" is used to connect to the HPC Slurm and PBS job schedulers to provision resources.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"VVEFIIgkSp"}],"key":"HHvDmFBneM"}],"key":"zxAOyBV0dg"}],"key":"uXvb577WwD"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"AqbT98HxQu"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"fLOMOLXgeG"},{"type":"text","value":" client python module can also be used to connect to existing clusters. A Dask Scheduler and Workers can be deployed in containers, or on Kubernetes, without using a Python function to create a dask cluster. The ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"hMSwSBI24n"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"raiaV0zpDv"},{"type":"text","value":" Client is configured to connect to the scheduler either by container name, or by the Kubernetes service name.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"oo71RudZ4i"}],"key":"kIY03C2ejE"}],"key":"pPDFnu5Tuh"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Select the Dask cluster type","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ATpoUnSYiF"}],"identifier":"select-the-dask-cluster-type","label":"Select the Dask cluster type","html_id":"select-the-dask-cluster-type","implicit":true,"key":"ZMu603PtnL"}],"key":"YlzHOVU3bZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The default will be ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mrcRpSJTaw"},{"type":"inlineCode","value":"LocalCluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J0Zo4Kqkca"},{"type":"text","value":" as that can run on any system.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dBMh6pdc2Y"}],"key":"IAqsR4yWcq"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"If running on a HPC computer with a PBS Scheduler, set to True. Otherwise, set to False.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cksh6AlehL"}],"key":"eR3OHSW4xf"}],"key":"SjiXI5dye1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"USE_PBS_SCHEDULER = False","key":"vBanWVXaNh"},{"type":"output","id":"o77jUqQBCKsIarFTqFqBf","data":[],"key":"WWukbnIya7"}],"key":"kPMNDPa5dI"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If running on Jupyter server with Dask Gateway configured, set to True. Otherwise, set to False.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xosCpnJXSH"}],"key":"ywh53SGjAZ"}],"key":"KwW4M6MsKQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"USE_DASK_GATEWAY = False","key":"lNQl0oXYyh"},{"type":"output","id":"8uNhNtnjtptjpYIFt_deO","data":[],"key":"kU9mgsNivz"}],"key":"q8XeyOXHKs"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python function for a PBS Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"udzXsCe4ID"}],"key":"R6rmp7m5k6"}],"key":"XX78BXLrYA"}],"key":"XbcnSBIVsI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create a PBS cluster object\ndef get_pbs_cluster():\n    \"\"\" Create cluster through dask_jobqueue.   \n    \"\"\"\n    from dask_jobqueue import PBSCluster\n    cluster = PBSCluster(\n        job_name = 'dask-pythia-24',\n        cores = 1,\n        memory = '4GiB',\n        processes = 1,\n        local_directory = rda_scratch + '/dask/spill',\n        resource_spec = 'select=1:ncpus=1:mem=4GB',\n        queue = 'casper',\n        walltime = '1:00:00',\n        #interface = 'ib0'\n        interface = 'ext'\n    )\n    return cluster","key":"mi5X65dWiF"},{"type":"output","id":"nvoYdn4GtieGlUQxD5Slv","data":[],"key":"jzcvJXsW6W"}],"key":"Q4AgDOinWe"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python function for a Gateway Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UeGvGhNJpT"}],"key":"BZplMHWXnu"}],"key":"XCu5eEezXF"}],"key":"KIJ23eRXyr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_gateway_cluster():\n    \"\"\" Create cluster through dask_gateway\n    \"\"\"\n    from dask_gateway import Gateway\n\n    gateway = Gateway()\n    cluster = gateway.new_cluster()\n    cluster.adapt(minimum=2, maximum=4)\n    return cluster","key":"q1huiXkcaV"},{"type":"output","id":"zh6GOsgTioDpgtGs11Cj9","data":[],"key":"wOwVMPGdTc"}],"key":"YJqHdeGYNa"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python function for a Local Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CejxhI53sd"}],"key":"WrIRiUPXUZ"}],"key":"wAFpEc7FO2"}],"key":"UCp85nxjnL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def get_local_cluster():\n    \"\"\" Create cluster using the Jupyter server's resources\n    \"\"\"\n    from distributed import LocalCluster, performance_report\n    cluster = LocalCluster()    \n\n    cluster.scale(4)\n    return cluster","key":"SH8lrJbAIx"},{"type":"output","id":"U8mM9RO76p42x1EvR00KG","data":[],"key":"GCw113iY6j"}],"key":"sWpCTlMThZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Python logic to select the Dask Cluster type","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aIywZ08fiG"}],"key":"IHjiSWk8ka"}],"key":"sZZHe6GeRi"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This uses True/False boolean logic based on the variables set in the previous cells","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"V6stBrieIp"}],"key":"CuRb3WDE76"}],"key":"XQ2mURPSdA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Obtain dask cluster in one of three ways\n\nif USE_PBS_SCHEDULER:\n    cluster = get_pbs_cluster()\nelif USE_DASK_GATEWAY:\n    cluster = get_gateway_cluster()\nelse:\n    cluster = get_local_cluster()\n\n# Connect to cluster\nfrom distributed import Client\nclient = Client(cluster)\n\n# Display cluster dashboard URL\ncluster","key":"uWrgA5CWoZ"},{"type":"output","id":"OFTeBvsNcdVrjf-Hy7gVF","data":[],"key":"SGLR6Lkihq"}],"key":"sZEIEuKVNV"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Open ERA5 annual means file","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y5sSpBQrU7"}],"identifier":"open-era5-annual-means-file","label":"Open ERA5 annual means file","html_id":"open-era5-annual-means-file","implicit":true,"key":"MHh1JSXJW5"}],"key":"HKRWFJGPHl"},{"type":"block","kind":"notebook-code","data":{"scrolled":true},"children":[{"type":"code","lang":"python","executable":true,"value":"baseline_temp = temp_2m_annual.sel(time= \\\n                                   temp_2m_annual.time.dt.year.isin(range(baseline_year_start, baseline_year_end+1))).mean('time')\nbaseline_temp ","key":"QN5wHm75qW"},{"type":"output","id":"o1kFDMTUucxb6v7AecszV","data":[],"key":"rNq4mjHDb5"}],"key":"pCgeOYl0ND"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_anomaly = temp_2m_annual - baseline_temp\ntemp_anomaly","key":"NtQ86WO3sX"},{"type":"output","id":"VNBkjCiAtt1vlmNGoirae","data":[],"key":"I20WOxygEG"}],"key":"KnnZoVNNbt"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Save anomaly","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eT0ek2DoQU"}],"identifier":"save-anomaly","label":"Save anomaly","html_id":"save-anomaly","implicit":true,"key":"LPIxTiiHrw"}],"key":"TnqY5IAEtO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# %%time\n# temp_anomaly.to_dataset().to_zarr(annual_means_posix + 'temp_anomaly_wrt_1940_1950.zarr')","key":"B8VCw1AlYx"},{"type":"output","id":"FJxLkQFgYvMpF4QDViZXJ","data":[],"key":"MLCatMiURJ"}],"key":"eITWWjxY1Z"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_anomaly = xr.open_zarr(annual_means_posix + 'temp_anomaly_wrt_1940_1950.zarr').VAR_2T\ntemp_anomaly","key":"vzxWsyLISP"},{"type":"output","id":"t-_VZbXzrPAW3xCtWKFIS","data":[],"key":"ZczfNl4o7j"}],"key":"o1XLUg2Bgx"},{"type":"block","kind":"notebook-content","children":[{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plot the temperature anomaly","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CxDxcSgupA"}],"key":"WoUDBAkydZ"}],"key":"paXEwnjxGi"}],"key":"e6PiBAtxX5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"temp_anomaly.isel(time=83).plot()","key":"ND45DGwyIh"},{"type":"output","id":"vzKIK4yDxBy8jjiVVTI0Y","data":[],"key":"bXDANEvEzN"}],"key":"AdHphdWfos"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Close the Dask Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f00CqNi8j4"}],"identifier":"close-the-dask-cluster","label":"Close the Dask Cluster","html_id":"close-the-dask-cluster","implicit":true,"key":"eo3zIcLGOW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"It’s best practice to close the Dask cluster when it’s no longer needed to free up the compute resources used.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hsJE656GQd"}],"key":"GMISBVNtW6"}],"key":"ZjHPRVVEoi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cluster.close()","key":"Q0CNomIaR6"},{"type":"output","id":"BK7lbNGmC-R0UflZrmj6y","data":[],"key":"t9QZu1Vi2y"}],"key":"UQT1E5uMS0"}],"key":"oLLHRpgjqd"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Generate annual/yearly zarr stores from hourly ERA5 NetCDF files on NCAR’s Research Data Archive","url":"/notebooks/data-preprocessing","group":"Preprocessing Notebooks for NCAR RDA"}}},"domain":"http://localhost:3000"}